<!DOCTYPE html>
<html>
<head>
    <title>Google Maps from Sheets (CSV)</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfGs1gnWhKjQvgeebgoMtptzwjMwBKwh0&libraries=places,marker&loading=async" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        #map { height: 800px; width: 100%; }
        #error-message { color: red; }
        #debug-info { margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="error-message"></div>
    <div id="debug-info"></div>

    <script>
        let map;
        let markers = [];

        const GEOCODING_CACHE_KEY = 'geocodingCache';
        const GEOCODING_DELAY = 500; // Délai en millisecondes

        async function geocodeWithCache(geocoder, cityName) {
            let cache = JSON.parse(localStorage.getItem(GEOCODING_CACHE_KEY) || '{}');

            if (cache[cityName]) {
                console.log(`Utilisation du cache pour ${cityName}`);
                return cache[cityName];
            }

            await new Promise(resolve => setTimeout(resolve, GEOCODING_DELAY));

            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': cityName + ', France' }, (results, status) => {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        cache[cityName] = { lat: location.lat(), lng: location.lng() };
                        localStorage.setItem(GEOCODING_CACHE_KEY, JSON.stringify(cache));
                        console.log(`Géocodage réussi pour ${cityName}`);
                        resolve(cache[cityName]);
                    } else {
                        console.error(`Erreur de géocodage pour ${cityName}: ${status}`);
                        reject(status);
                    }
                });
            });
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 9,
                center: {lat: 43.603354, lng: 6.588334},
                mapId: 'DEMO_MAP_ID'
            });

            updateData();
            setInterval(updateData, 10000); // Mise à jour toutes les 10 secondes
        }

        async function updateData() {
            const geocoder = new google.maps.Geocoder();
            let debugInfo = "";

            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSgn7Ua3wOiYoVnr2Tl-dSiBucRC_w0mUEJdMmdmeySAEiEBkBGyLmjuXcCSkR_AYzt_r92du7FfWHk/pub?gid=527237974&single=true&output=csv');
                const csv = await response.text();
                
                Papa.parse(csv, {
                    complete: async function(results) {
                        console.log("Parsed CSV:", results.data);
                        debugInfo += `Nombre total de lignes: ${results.data.length}\n`;

                        let enCoursCount = 0;
                        let markersCreatedCount = 0;

                        for (let i = 1; i < results.data.length; i++) {
                            const row = results.data[i];
                            if (row.length >= 14) {
                                const name = row[0].trim();
                                const espece = row[4].trim();
                                const cityName = row[3].trim();
                                const Numero = row[2].trim();
                                const status = row[13].trim();

                                debugInfo += `Ligne ${i}: ${name}, Status: "${status}", Ville: ${cityName}\n`;

                                if (status.toLowerCase() === "en cours") {
                                    enCoursCount++;
                                    debugInfo += `  Tentative de création de marqueur pour : ${name}\n`;
                                    try {
                                        const location = await geocodeWithCache(geocoder, cityName);

                                        const marker = new google.maps.marker.AdvancedMarkerElement({
                                            position: location,
                                            map: map,
                                            title: `${name} (${espece} ${Numero} ${status})`
                                        });

                                        markers.push(marker);
                                        markersCreatedCount++;
                                        debugInfo += `  Marqueur créé pour : ${name}\n`;
                                    } catch (geocodeStatus) {
                                        debugInfo += `  Erreur de géocodage pour ${cityName}: ${geocodeStatus}\n`;
                                        document.getElementById('error-message').textContent += `Erreur de géocodage pour ${cityName} : ${geocodeStatus}. `;
                                    }
                                }
                            } else {
                                debugInfo += `Ligne ${i} avec moins de 14 colonnes\n`;
                            }
                        }

                        // Suppression des marqueurs qui ne sont plus "En cours"
                        markers = markers.filter(marker => {
                            const name = marker.title.split(' (')[0];
                            const currentMarkers = results.data.filter(row => row.length >= 14).map(row => ({ name: row[0].trim(), status: row[13].trim() }));
                            const status = currentMarkers.find(markerInfo => markerInfo.name === name)?.status;
                            if (status !== "En cours") {
                                marker.map = null;
                                debugInfo += `Suppression du marqueur pour : ${name}\n`;
                                return false;
                            }
                            return true;
                        });

                        debugInfo += `Nombre d'éléments "En cours" : ${enCoursCount}\n`;
                        debugInfo += `Nombre de marqueurs créés : ${markersCreatedCount}\n`;
                        debugInfo += `Nombre final de marqueurs : ${markers.length}\n`;

                        document.getElementById('debug-info').textContent = debugInfo;
                    }
                });

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('error-message').textContent = "Erreur lors de la récupération des données. Vérifiez la console.";
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
